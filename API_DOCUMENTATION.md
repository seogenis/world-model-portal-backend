# World Model Portal API Documentation

This document describes the available API endpoints for interacting with the World Model Portal backend, which provides text-to-video generation services using NVIDIA's Cosmos text-to-video model.

## Table of Contents

- [Base URL](#base-url)
- [User Flow Sequence](#user-flow-sequence)
- [Prompt Management Endpoints](#prompt-management-endpoints)
- [Video Generation Endpoints](#video-generation-endpoints)
- [Removed Endpoints](#removed-endpoints)
- [Session Management](#session-management)
- [Status Codes](#status-codes)
- [Status Values](#status-values)
- [Rate Limiting](#rate-limiting)
- [Error Handling](#error-handling)
- [Frontend Integration Tips](#frontend-integration-tips)

## Base URL

All API endpoints are prefixed with `/api`.

## User Flow Sequence

The typical user flow follows this sequence:

1. **Enhance a rough prompt** (`POST /api/enhance`)
2. **Initialize parameters** (`POST /api/initialize`) 
3. **Generate a single video** (`POST /api/video/single_inference`)
4. **Generate prompt variations** (`POST /api/generate-variations`)
5. **Update prompt through conversation** (`POST /api/update`)
6. **Generate new videos with refined prompts** (`POST /api/video/single_inference`)

## Prompt Management Endpoints

### 1. Enhance Prompt

**Endpoint:** `POST /api/enhance`

Enhance a basic prompt with more descriptive details.

**Request:**
```json
{
  "rough_prompt": "cats playing",
  "session_id": "optional-session-id-string"
}
```

**Response:**
```json
{
  "original_prompt": "cats playing",
  "enhanced_prompt": "Two fluffy tabby cats playfully chasing each other through a sunlit living room, their paws batting at colorful toy mice",
  "session_id": "generated-or-provided-session-id"
}
```

### 2. Initialize Prompt

**Endpoint:** `POST /api/initialize`

Initialize the system with a new prompt for refinement.

**Request:**
```json
{
  "prompt": "A colorful sunset over the ocean",
  "session_id": "optional-session-id-string"
}
```

**Response:**
```json
{
  "parameters": {
    "time": "sunset",
    "scene": "ocean",
    "colors": ["orange", "red", "purple"],
    "additional_parameters": "..."
  },
  "prompt": "A colorful sunset over the ocean",
  "changes": [],
  "session_id": "generated-or-provided-session-id"
}
```

### 3. Update Prompt

**Endpoint:** `POST /api/update`

Update the prompt based on a natural language request.

**Request:**
```json
{
  "user_request": "Make it more dramatic with stormy clouds",
  "session_id": "your-session-id"
}
```

**Response:**
```json
{
  "parameters": {
    "time": "sunset",
    "scene": "ocean",
    "weather": "stormy",
    "sky": "dramatic clouds",
    "additional_parameters": "..."
  },
  "prompt": "A dramatic sunset over the stormy ocean with dark clouds gathering on the horizon",
  "changes": [
    "Added stormy weather",
    "Made sky more dramatic with clouds"
  ],
  "session_id": "your-session-id"
}
```

### 4. Generate Variations

**Endpoint:** `POST /api/generate-variations`

Generate variations of selected prompts from history. This endpoint will always return exactly the number of prompts specified in `total_count`, regardless of how many prompts are selected.

**Request:**
```json
{
  "selected_indices": [0, 2],
  "total_count": 8,
  "session_id": "your-session-id"
}
```

**Response:**
```json
{
  "prompts": [
    "A dramatic sunset over the stormy ocean with lightning strikes illuminating dark clouds",
    "A peaceful sunset over calm ocean waters with gentle waves and seagulls flying overhead",
    "A vibrant sunset over a tropical ocean with palm trees silhouetted against the colorful sky",
    "A misty sunset over a rocky coastline with waves crashing against the shore",
    "A sunset over an arctic ocean with icebergs reflecting orange and purple hues",
    "A sunset over a bustling harbor with silhouettes of boats against the orange sky",
    "A dramatic sunset over the ocean with a distant sailboat on the horizon",
    "A sunset over a pristine beach with footprints in the sand leading to the water"
  ],
  "selected_indices": [0, 2],
  "session_id": "your-session-id"
}
```

**Important Notes:**
- This endpoint is guaranteed to always return exactly `total_count` prompts
- If insufficient variations are generated by the AI, the system will use fallback mechanisms to reach the requested count
- Some prompts may be marked as fallbacks or duplicates in cases where generation is challenging

### 5. Get Prompt History

**Endpoint:** `POST /api/history`

Get the history of all prompts created in the specified session.

**Request:**
```json
{
  "session_id": "your-session-id"
}
```

**Response:**
```json
{
  "history": [
    {
      "prompt": "A colorful sunset over the ocean",
      "parameters": {
        "time": "sunset",
        "scene": "ocean",
        "colors": ["orange", "red", "purple"]
      },
      "description": "Initial prompt"
    },
    {
      "prompt": "A dramatic sunset over the stormy ocean with dark clouds gathering on the horizon",
      "parameters": {
        "time": "sunset",
        "scene": "ocean",
        "weather": "stormy",
        "sky": "dramatic clouds"
      },
      "description": "Added storm effects"
    }
  ],
  "session_id": "your-session-id"
}
```

### 6. Get Current Parameters

**Endpoint:** `POST /api/parameters`

Get the current parameters extracted from the active prompt for a specific session.

**Request:**
```json
{
  "session_id": "your-session-id"
}
```

**Response:**
```json
{
  "parameters": {
    "time": "sunset",
    "scene": "ocean",
    "weather": "stormy",
    "sky": "dark clouds",
    "additional_parameters": "..."
  },
  "session_id": "your-session-id"
}
```

## Video Generation Endpoints

### 1. Generate Single Video

**Endpoint:** `POST /api/video/single_inference`

Generates a single video from a text prompt.

**Request:**
```json
{
  "prompt": "A beautiful sunrise over a mountain lake with reflections in the water"
}
```

**Response:**
```json
{
  "job_id": "550e8400-e29b-41d4-a716-446655440000",
  "message": "Video generation started. Check status endpoint for updates."
}
```

### 2. Get Single Video Status

**Endpoint:** `GET /api/video/status/{job_id}`

Get the current status of a single video generation job.

**Response:**
```json
{
  "job_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "generating",
  "message": "Generating video from prompt",
  "progress": 65,
  "video_url": null
}
```

## Removed Endpoints

The following endpoints have been removed from the API:

- `GET /api/videos/{video_id}` - Video file retrieval endpoint
- `POST /api/video/batch_inference` - Batch video generation endpoint
- `GET /api/video/batch_status/{batch_id}` - Batch status retrieval endpoint
- `GET /api/video/batch_download/{batch_id}` - Batch download endpoint

Please use the current S3-based video URLs provided by the `/api/video/status/{job_id}` endpoint for accessing generated videos.

### 4. Clean Expired Jobs

**Endpoint:** `POST /api/video/clean_expired?max_age={seconds}`

Manually clean up single inference jobs that have been in the queue too long.

**Query Parameters:**
- `max_age`: Maximum age in seconds for jobs (default: 300 seconds/5 minutes)

**Response:**
```json
{
  "queue_size_before": 10,
  "queue_size_after": 3,
  "expired_jobs_removed": 7
}
```

## Video Storage

The system now stores generated videos in Amazon S3:

### Video Access

- When a video generation is complete, the `video_url` field in the status response will provide a presigned S3 URL
- The presigned URLs typically expire after a few minutes (default: 5 minutes)
- To access a video after the URL has expired, request a new status via the `/api/video/status/{job_id}` endpoint

### S3 Storage Structure

- Videos are stored in the "cosmos-storage" S3 bucket
- Each video has a unique key generated when the video creation task completes
- The video_key field (if provided in the request) determines where uploaded videos for reference are stored

## Frontend Integration Tips

### Displaying Videos

1. **Direct embedding**: Use the `video_url` from status responses (these are presigned S3 URLs)
   ```html
   <video src="https://cosmos-storage.s3.amazonaws.com/path/to/video.mp4?X-Amz-Algorithm=..." controls></video>
   ```

2. **Handle URL expiration**: Since S3 presigned URLs expire after a few minutes, implement refresh logic
   ```javascript
   // Check if URL might be expired (e.g., if it's been more than 4 minutes since last refresh)
   if (Date.now() - lastRefreshTime > 240000) {
     // Fetch a new status to get a fresh video URL
     fetchVideoStatus(jobId).then(status => {
       if (status.video_url) {
         videoElement.src = status.video_url;
         lastRefreshTime = Date.now();
       }
     });
   }
   ```

3. **Efficient polling**: Implement exponential backoff when checking status
   ```javascript
   // Start with 1-2 second interval, gradually increase to max 10-15 seconds
   const interval = Math.min(baseInterval * Math.pow(1.1, pollCount), maxInterval);
   ```

4. **Cross-origin considerations**: Ensure proper CORS handling for S3 URLs
   ```html
   <video src="..." crossorigin="anonymous" controls></video>
   ```

## Session Management

### 1. List Active Sessions

**Endpoint:** `GET /api/sessions`

List all active sessions with their last access times.

**Response:**
```json
{
  "sessions": {
    "session-id-1": 1717027814.5678,
    "session-id-2": 1717027885.1234,
    "session-id-3": 1717027900.9876
  }
}
```

### 2. Delete Session

**Endpoint:** `DELETE /api/session/{session_id}`

Delete a specific session and its associated data.

**Response:**
```json
{
  "message": "Session session-id-1 deleted successfully"
}
```

## Session Management Details

All prompt-related endpoints support session-based state management:

- Sessions are created automatically when not provided
- Session IDs should be included in the request body for each call after initial creation
- Session data persists across API calls
- All sessions expire after 1 hour of inactivity (configurable)
- Session creation is rate-limited to 10 sessions per minute per IP

## Status Codes

- `200 OK`: Request successful
- `400 Bad Request`: Invalid request parameters
- `404 Not Found`: Resource not found
- `429 Too Many Requests`: Rate limit exceeded (NVIDIA API or session creation)
- `500 Internal Server Error`: Server error

## Status Values

### Single Video Status

- `pending`: Job is queued or waiting to start
- `generating`: Video generation in progress on NVIDIA API
- `processing`: Local processing of video files (extracting from zip)
- `complete`: Video generation complete
- `failed`: Video generation failed
- `expired`: Job removed from queue after waiting too long (default: 5 minutes)

### Batch Status

- `processing`: Batch is currently being processed
- `complete`: All jobs in batch completed successfully
- `partial`: Some jobs completed, some failed
- `failed`: All jobs in batch failed
- `not_found`: Batch ID not found

## Rate Limiting

- **NVIDIA API**: Limited to 1 concurrent request per API key
- **Session Creation**: Limited to 10 sessions per minute per IP address
- **Background Processing**: Limited by available GPUs (defaults to 8)

## Error Handling

API errors follow standard HTTP status codes with descriptive messages. Common errors include:

- **NVIDIA API Authentication**: Check API key configuration
- **Rate Limiting**: Wait and retry with exponential backoff
- **Missing Session**: Initialize a prompt first
- **Invalid Parameters**: Check request format and parameters
- **Resource Not Found**: Verify IDs for videos, batches, and sessions

For robust applications, implement:
- Proper error handling for all API calls
- Polling with appropriate intervals for status updates
- Exponential backoff for retrying failed operations